<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Notes - SCRIBE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/course1.css">
    <link rel="stylesheet" href="/css/lecture-notes.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Force left sidebar to be fixed and always visible */
        .dashboard-container { display: block !important; }
        .dashboard-container .sidebar {
            position: fixed !important;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        .dashboard-container .main-content { margin-left: var(--sidebar-width) !important; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>SCRIBE</h1>
            </div>
            <nav class="nav-menu">
                <a href="/studentdashboard.html" class="nav-item dashboard-link">
                    <i class="bi bi-house"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item back-to-course">
                    <i class="bi bi-arrow-left"></i>
                    <span>Back to Course</span>
                </a>
                <a href="/help.html" class="nav-item">
                    <i class="bi bi-question-circle"></i>
                    <span>Help</span>
                </a>
                <a href="/login.html" class="nav-item">
                    <i class="bi bi-box-arrow-left"></i>
                    <span>Logout</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="lecture-header">
                <div class="header-content">
                    <h1 id="lectureTitle">Loading...</h1>
                    <div class="lecture-meta">
                        <span id="lectureDate"></span>
                    </div>
                </div>
                <button id="modifyNotesBtn" class="modify-notes-btn" aria-label="Modify Notes">
                    <i class="bi bi-list"></i>
                </button>
            </div>

            <div class="breadcrumb">
                <a href="#" id="courseBreadcrumb">Loading...</a>
                <i class="bi bi-chevron-right"></i>
                <span id="lectureBreadcrumb">Loading...</span>
            </div>

            <div class="content-grid">
                <!-- Audio Player Section -->
                <section id="audio-section" class="audio-section" style="display: none;">
                    <h2>Lecture Recording</h2>
                    <audio id="lectureAudio" controls></audio>
                </section>

                <!-- Transcription Section -->
                <section id="transcription-section" class="transcription-section">
                    <h2>Lecture Transcription <button id="downloadTranscription" class="download-btn"><i class="bi bi-download"></i> Download PDF</button></h2>
                    <div id="transcriptionText" class="transcription-content definable"></div>
                </section>

                <!-- Notes Section -->
                <section id="notes-section" class="notes-section">
                    <h2>My Notes</h2>
                    <div class="notes-container">
                        <!-- Add a container div with fixed height -->
                        <div class="editor-container">
                            <div id="editor">
                            </div>
                        </div>
                        <button id="saveNotes" class="save-btn">
                            <i class="bi bi-save"></i>
                            Save Notes
                        </button>
                    </div>
                </section>

                <!-- Enhanced Summary Section -->
                <section class="summary-section" style="display: none;">
                    <div class="summary-content">
                        <h3 class="summary-title"></h3>
                        
                        <!-- Context and Purpose -->
                        <div class="summary-overview">
                            <h4>Context & Purpose</h4>
                            <div class="overview-box">
                                <p class="definable"><strong>Main Theme:</strong> <span id="mainThesis"></span></p>
                                <p class="definable"><strong>Scientific Context:</strong> <span id="context"></span></p>
                                <p class="definable"><strong>Real-World Significance:</strong> <span id="significance"></span></p>
                            </div>
                        </div>

                        <!-- Main Discussion Points -->
                        <div class="key-points">
                            <h4>Main Discussion Points</h4>
                            <div id="keyPoints"></div>
                        </div>

                        <!-- Practical Applications -->
                        <div class="practical-applications">
                            <h4>Practical Applications & Real-World Examples</h4>
                            <div id="applications"></div>
                        </div>
                    </div>
                </section>

                <!-- Visual Learning Section -->
                <section id="visual-learning-section" class="visual-learning-section" style="display: none;">
                    <h2>Visual Learning</h2>
                    <div class="visual-content">
                        <!-- Visual learning content here -->
                    </div>
                </section>

                <!-- Interactive Learning Section -->
                <section id="kinesthetic-section" class="kinesthetic-section" style="display: none;">
                    <h2>Interactive Learning</h2>
                    <div class="interactive-content">
                        <!-- Interactive learning content here -->
                    </div>
                    <div class="quiz-controls">
                        <button class="check-answers-btn">Check Answers</button>
                        <button class="reset-quiz-btn">Reset Quiz</button>
                        <button class="explanation-btn" disabled>Show Explanation</button>
                    </div>
                </section>

                <!-- Flashcards Section -->
                <section id="flashcards-section" class="flashcards-section" style="display: none;">
                    <h2>Flashcards</h2>
                    <div class="flashcards-content">
                        <!-- Flashcards content here -->
                    </div>
                </section>
            </div>

            <!-- Quick Jump Menu -->
            <div class="quick-jump">
                <button class="quick-jump-btn" onclick="toggleQuickJump()">
                    <i class="bi bi-list"></i>
                    Quick Jump
                </button>
                <div class="quick-jump-menu">
                    <!-- Quick Jump menu content will be dynamically populated -->
                </div>
            </div>
        </main>

        <!-- Modify Notes Sidebar -->
        <div id="modifySidebar" class="modify-sidebar">
            <div class="sidebar-header">
                <h3>Modify Your Notes</h3>
                <button id="closeSidebar" class="close-btn" aria-label="Close sidebar">Ã—</button>
            </div>
            <div class="sidebar-content">
                <div class="preferences-section">
                    <div class="preference-card">
                        <div class="preference-icon">
                            <i class="bi bi-file-text"></i>
                        </div>
                        <div class="preference-details">
                            <h4>Summarization</h4>
                            <p>Generate a concise summary of the lecture content</p>
                            <label class="toggle-switch">
                                <input type="checkbox" id="summarization">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="preference-card">
                        <div class="preference-icon">
                            <i class="bi bi-card-text"></i>
                        </div>
                        <div class="preference-details">
                            <h4>Flashcards</h4>
                            <p>Create study flashcards from key concepts</p>
                            <label class="toggle-switch">
                                <input type="checkbox" id="flashcards">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="preference-card">
                        <div class="preference-icon">
                            <i class="bi bi-volume-up"></i>
                        </div>
                        <div class="preference-details">
                            <h4>Audio</h4>
                            <p>Show lecture recording player</p>
                            <label class="toggle-switch">
                                <input type="checkbox" id="audio">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="preference-card">
                        <div class="preference-icon">
                            <i class="bi bi-eye"></i>
                        </div>
                        <div class="preference-details">
                            <h4>Visual Learning</h4>
                            <p>Enhance understanding with relevant images sourced from key lecture concepts</p>
                            <label class="toggle-switch">
                                <input type="checkbox" id="visual">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="preference-card">
                        <div class="preference-icon">
                            <i class="bi bi-hand-index"></i>
                        </div>
                        <div class="preference-details">
                            <h4>Quizzes</h4>
                            <p>Test your understanding and track your progress with interactive questions</p>
                            <label class="toggle-switch">
                                <input type="checkbox" id="kinesthetic">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="save-button-container">
                    <button class="preferences-save-btn" id="savePreferences">
                        <i class="bi bi-check2"></i>
                        Apply Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/definitions.js"></script>
    <script src="/js/student-lecture-notes.js"></script>
    <script>
        // Simple function to toggle quick jump menu
        function toggleQuickJump() {
            const menu = document.querySelector('.quick-jump-menu');
            menu.classList.toggle('show');
        }

        // Enhanced scroll function
        function scrollToSection(sectionId) {
            console.log('Attempting to scroll to:', sectionId);
            // Try different ways to find the section
            const section = document.querySelector(`section#${sectionId}, section.${sectionId}`);
            
            if (section) {
                console.log('Found section:', sectionId, 'Current display:', section.style.display);
                
                // Show the section if it's hidden
                if (section.style.display === 'none') {
                    const checkboxId = {
                        'audio-section': 'audio',
                        'summary-section': 'summarization',
                        'flashcards-section': 'flashcards',
                        'visual-learning-section': 'visual',
                        'kinesthetic-section': 'kinesthetic'
                    }[sectionId];

                    console.log('Looking for checkbox:', checkboxId);
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) {
                        console.log('Found checkbox, setting checked');
                        checkbox.checked = true;
                        section.style.display = 'block';
                    }
                }

                // Force a reflow to ensure the section is visible
                void section.offsetHeight;

                // Scroll to the section
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Close the menu
                document.querySelector('.quick-jump-menu').classList.remove('show');
            } else {
                console.error('Section not found:', sectionId);
                // Log all available sections for debugging
                const allSections = document.querySelectorAll('section');
                console.log('Available sections:', Array.from(allSections).map(s => ({
                    id: s.id,
                    className: s.className,
                    display: s.style.display
                })));
            }
        }

        // Update the quick jump menu items
        function updateQuickJumpMenu() {
            const menu = document.querySelector('.quick-jump-menu');
            menu.innerHTML = '';

            // Always show these sections
            const alwaysVisibleSections = [
                { id: 'transcription-section', name: 'Lecture Transcription', icon: 'bi-text-paragraph' },
                { id: 'notes-section', name: 'My Notes', icon: 'bi-journal-text' }
            ];

            // Optional sections controlled by preferences
            const optionalSections = [
                { id: 'audio-section', name: 'Audio Player', icon: 'bi-mic', checkboxId: 'audio' },
                { id: 'summary-section', name: 'Summary', icon: 'bi-card-text', checkboxId: 'summarization' },
                { id: 'visual-learning-section', name: 'Visual Learning', icon: 'bi-image', checkboxId: 'visual' },
                { id: 'kinesthetic-section', name: 'Interactive Learning', icon: 'bi-puzzle', checkboxId: 'kinesthetic' },
                { id: 'flashcards-section', name: 'Flashcards', icon: 'bi-card-list', checkboxId: 'flashcards' }
            ];

            // Add always visible sections
            alwaysVisibleSections.forEach(section => {
                const sectionElement = document.querySelector(`section#${section.id}`);
                if (sectionElement) {
                    const item = document.createElement('div');
                    item.className = 'quick-jump-item';
                    item.innerHTML = `<i class="bi ${section.icon}"></i>${section.name}`;
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        scrollToSection(section.id);
                    });
                    menu.appendChild(item);
                }
            });

            // Add optional sections if their checkbox is checked
            optionalSections.forEach(section => {
                const checkbox = document.getElementById(section.checkboxId);
                const sectionElement = document.querySelector(`section#${section.id}`);
                if (checkbox && checkbox.checked && sectionElement) {
                    const item = document.createElement('div');
                    item.className = 'quick-jump-item';
                    item.innerHTML = `<i class="bi ${section.icon}"></i>${section.name}`;
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        scrollToSection(section.id);
                    });
                    menu.appendChild(item);
                }
            });
        }

        // Handle preferences
        document.addEventListener('DOMContentLoaded', function() {
            const savePreferences = document.getElementById('savePreferences');
            
            savePreferences.addEventListener('click', function() {
                // Update section visibility
                const preferences = {
                    'audio': 'audio-section',
                    'summarization': 'summary-section',
                    'flashcards': 'flashcards-section',
                    'visual': 'visual-learning-section',
                    'kinesthetic': 'kinesthetic-section'
                };

                Object.entries(preferences).forEach(([prefId, sectionId]) => {
                    const isChecked = document.getElementById(prefId).checked;
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.style.display = isChecked ? 'block' : 'none';
                        console.log(`Setting ${sectionId} display to:`, isChecked ? 'block' : 'none');
                    } else {
                        console.error(`Section not found: ${sectionId}`);
                    }
                });

                updateQuickJumpMenu();
                document.getElementById('modifySidebar').classList.remove('show');
            });

            // Initial menu update
            updateQuickJumpMenu();
            
            // PDF Download functionality
            const { jsPDF } = window.jspdf;
            
            // Helper function to format date for filenames
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Setup download buttons
            document.getElementById('downloadTranscription').addEventListener('click', function() {
                downloadSectionAsPDF('transcription-section', 'lecture-transcription');
            });
            
            document.getElementById('downloadSummary').addEventListener('click', function() {
                downloadSectionAsPDF('summary-section', 'lecture-summary');
            });
            
            // Function to download a section as PDF
            function downloadSectionAsPDF(sectionId, filename) {
                const section = document.getElementById(sectionId);
                const lectureTitle = document.getElementById('lectureTitle').textContent;
                const lectureDate = document.getElementById('lectureDate').textContent;
                
                // Create a loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'loading-indicator';
                loadingIndicator.innerHTML = `
                    <div class="loading-spinner"></div>
                    <span>Generating PDF...</span>
                `;
                document.body.appendChild(loadingIndicator);
                
                try {
                    // Create PDF (A4 format)
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const margin = 15; // 15mm margin
                    
                    // Common header for both PDF types
                    const addHeader = () => {
                        // Add title
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(16);
                        pdf.text(lectureTitle, margin, margin + 10);
                        
                        // Add date
                        pdf.setFontSize(12);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text(lectureDate, margin, margin + 20);
                        
                        // Add a horizontal line
                        pdf.setDrawColor(200, 200, 200);
                        pdf.line(margin, margin + 25, pdfWidth - margin, margin + 25);
                        
                        return margin + 35; // Return starting y position for content
                    };
                    
                    // Different handling for transcript vs summary
                    if (sectionId === 'transcription-section') {
                        // Get the formatted HTML content
                        const transcriptionElement = document.getElementById('transcriptionText');
                        
                        // Add header and get starting y position
                        let y = addHeader();
                        
                        // Add title for transcript section
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(14);
                        pdf.text('Lecture Transcription', margin, y);
                        y += 10;
                        
                        // Format settings for main content
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(12);
                        
                        // Improved HTML formatting extraction
                        const extractText = (element) => {
                            let text = '';
                            Array.from(element.childNodes).forEach(node => {
                                if (node.nodeType === Node.TEXT_NODE) {
                                    text += node.textContent;
                                } else if (node.nodeType === Node.ELEMENT_NODE) {
                                    // Handle specific HTML elements with better formatting
                                    switch(node.nodeName) {
                                        case 'H1':
                                            text += '\n' + node.textContent.toUpperCase() + '\n';
                                            break;
                                        case 'H2':
                                            text += '\n' + node.textContent + '\n';
                                            break;
                                        case 'H3':
                                        case 'H4':
                                            text += '\n' + node.textContent + '\n';
                                            break;
                                        case 'P':
                                            text += '\n' + extractText(node);
                                            break;
                                        case 'UL':
                                        case 'OL':
                                            text += '\n';
                                            Array.from(node.querySelectorAll('li')).forEach(li => {
                                                text += '\nâ€¢ ' + li.textContent.trim();
                                            });
                                            text += '\n';
                                            break;
                                        case 'LI':
                                            // Handle direct list items
                                            text += '\nâ€¢ ' + node.textContent.trim();
                                            break;
                                        case 'STRONG':
                                        case 'B':
                                            // Mark text for bold formatting
                                            text += '[B]' + extractText(node) + '[/B]';
                                            break;
                                        case 'EM':
                                        case 'I':
                                            // Mark text for italic formatting
                                            text += '[I]' + extractText(node) + '[/I]';
                                            break;
                                        case 'BR':
                                            text += '\n';
                                            break;
                                        case 'BLOCKQUOTE':
                                            text += '\n\n"' + extractText(node) + '"\n\n';
                                            break;
                                        case 'CODE':
                                            text += '\n```\n' + node.textContent + '\n```\n';
                                            break;
                                        case 'PRE':
                                            text += '\n```\n' + node.textContent + '\n```\n';
                                            break;
                                        default:
                                            text += extractText(node);
                                    }
                                }
                            });
                            return text;
                        };
                        
                        if (transcriptionElement.innerHTML.includes('<')) {
                            // Process formatted content
                            let formattedText = extractText(transcriptionElement).trim();
                            
                            // Process styling markers
                            const processStyledText = (text, pdf, x, y, width) => {
                                // Split text by formatting markers
                                const parts = [];
                                let currentIndex = 0;
                                let bold = false;
                                let italic = false;
                                
                                // Find formatting markers and split text
                                while (currentIndex < text.length) {
                                    const boldStart = text.indexOf('[B]', currentIndex);
                                    const boldEnd = text.indexOf('[/B]', currentIndex);
                                    const italicStart = text.indexOf('[I]', currentIndex);
                                    const italicEnd = text.indexOf('[/I]', currentIndex);
                                    
                                    let nextMarker = -1;
                                    let markerType = '';
                                    
                                    if (boldStart !== -1 && (nextMarker === -1 || boldStart < nextMarker)) {
                                        nextMarker = boldStart;
                                        markerType = 'boldStart';
                                    }
                                    if (boldEnd !== -1 && (nextMarker === -1 || boldEnd < nextMarker)) {
                                        nextMarker = boldEnd;
                                        markerType = 'boldEnd';
                                    }
                                    if (italicStart !== -1 && (nextMarker === -1 || italicStart < nextMarker)) {
                                        nextMarker = italicStart;
                                        markerType = 'italicStart';
                                    }
                                    if (italicEnd !== -1 && (nextMarker === -1 || italicEnd < nextMarker)) {
                                        nextMarker = italicEnd;
                                        markerType = 'italicEnd';
                                    }
                                    
                                    if (nextMarker === -1) {
                                        // No more markers, add remaining text
                                        parts.push({
                                            text: text.substring(currentIndex),
                                            bold: bold,
                                            italic: italic
                                        });
                                        break;
                                    } else {
                                        // Add text before marker
                                        if (nextMarker > currentIndex) {
                                            parts.push({
                                                text: text.substring(currentIndex, nextMarker),
                                                bold: bold,
                                                italic: italic
                                            });
                                        }
                                        
                                        // Update formatting state
                                        if (markerType === 'boldStart') {
                                            bold = true;
                                            currentIndex = nextMarker + 3; // [B] length
                                        } else if (markerType === 'boldEnd') {
                                            bold = false;
                                            currentIndex = nextMarker + 4; // [/B] length
                                        } else if (markerType === 'italicStart') {
                                            italic = true;
                                            currentIndex = nextMarker + 3; // [I] length
                                        } else if (markerType === 'italicEnd') {
                                            italic = false;
                                            currentIndex = nextMarker + 4; // [/I] length
                                        }
                                    }
                                }
                                
                                // Remove empty parts
                                return parts.filter(part => part.text.length > 0);
                            };
                            
                            // Remove formatting markers for line splitting
                            const cleanText = formattedText.replace(/\[B\]|\[\/B\]|\[I\]|\[\/I\]/g, '');
                            
                            // Split text into lines that fit the page width
                            const textLines = pdf.splitTextToSize(
                                cleanText, 
                                pdfWidth - (2 * margin)
                            );
                            
                            // Add text with pagination
                            const lineHeight = 6; // Reduced from 7mm for more compact output
                            for (let i = 0; i < textLines.length; i++) {
                                // Check for page break
                                if (y > pdfHeight - margin - lineHeight) {
                                    pdf.addPage();
                                    y = margin + 10;
                                }
                                
                                // Check if line is a heading (all caps with at least 3 chars)
                                const isHeading = textLines[i].match(/^[A-Z0-9\s]{3,}$/);
                                if (isHeading) {
                                    pdf.setFont('helvetica', 'bold');
                                    pdf.setFontSize(14);
                                } else {
                                    pdf.setFont('helvetica', 'normal');
                                    pdf.setFontSize(12);
                                }
                                
                                pdf.text(textLines[i], margin, y);
                                y += lineHeight;
                            }
                        } else {
                            // Fallback to plain text if no HTML formatting
                            const transcriptionText = transcriptionElement.textContent.trim();
                            
                            // Split text into lines that fit the page width
                            const textLines = pdf.splitTextToSize(
                                transcriptionText, 
                                pdfWidth - (2 * margin)
                            );
                            
                            // Add text with pagination
                            const lineHeight = 6; // Reduced from 7mm
                            for (let i = 0; i < textLines.length; i++) {
                                // If we're going to go beyond the page, add a new one
                                if (y > pdfHeight - margin - lineHeight) {
                                    pdf.addPage();
                                    y = margin + 10;
                                }
                                pdf.text(textLines[i], margin, y);
                                y += lineHeight;
                            }
                        }
                    } else if (sectionId === 'summary-section') {
                        // Constants for layout
                        const lineHeight = 6; // Reduced from 7mm
                        const sectionSpacing = 12; // Reduced from 15
                        const itemSpacing = 6; // Reduced from 8
                        const bulletIndent = 5; // Indent for bullet points
                        
                        // Add header and get starting y position
                        let yPosition = addHeader();
                        
                        // Extract the summary title if present
                        const summaryTitle = section.querySelector('.summary-title').textContent.trim();
                        if (summaryTitle) {
                            pdf.setFont('helvetica', 'bold');
                            pdf.setFontSize(14);
                            pdf.text(summaryTitle, margin, yPosition);
                            yPosition += 10;
                        }
                        
                        // Function to handle pagination and ensure text doesn't overflow
                        const ensureSpace = (requiredSpace) => {
                            if (yPosition + requiredSpace > pdfHeight - margin) {
                                pdf.addPage();
                                yPosition = margin + 10;
                                return true;
                            }
                            return false;
                        };
                        
                        // Function to add a section heading
                        const addSectionHeading = (text) => {
                            ensureSpace(15);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setFontSize(14);
                            pdf.text(text, margin, yPosition);
                            yPosition += 10;
                        };
                        
                        // Function to add a subsection heading
                        const addSubHeading = (text) => {
                            ensureSpace(12);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setFontSize(12);
                            pdf.text(text, margin, yPosition);
                            yPosition += 8;
                        };
                        
                        // Function to add a labeled text with proper spacing
                        const addLabeledText = (label, text) => {
                            ensureSpace(text.length / 50 * lineHeight + 20);
                            
                            // Add the label on its own line
                            pdf.setFont('helvetica', 'bold');
                            pdf.setFontSize(12);
                            pdf.text(`${label}:`, margin, yPosition);
                            yPosition += 7; // Move down to position content below the label
                            
                            // Add the content below the label
                            pdf.setFont('helvetica', 'normal');
                            const textLines = pdf.splitTextToSize(text, pdfWidth - (2 * margin));
                            pdf.text(textLines, margin, yPosition);
                            
                            // Update y position for next item
                            yPosition += (textLines.length * lineHeight) + itemSpacing;
                        };
                        
                        // Function to add a bulleted item
                        const addBulletedItem = (text) => {
                            ensureSpace(Math.max((text.length / 40) * lineHeight + 5, 10));
                            
                            // Add bullet
                            pdf.text('â€¢', margin + bulletIndent, yPosition);
                            
                            // Add text with indent after bullet
                            const textLines = pdf.splitTextToSize(text, pdfWidth - margin - 15 - bulletIndent);
                            pdf.text(textLines, margin + 15, yPosition);
                            yPosition += (textLines.length * lineHeight) + 4;
                        };
                        
                        // Extract the context and purpose section
                        addSectionHeading('Context & Purpose');
                        
                        // Main Theme
                        const mainThesis = document.getElementById('mainThesis').textContent.trim();
                        addLabeledText('Main Theme', mainThesis);
                        
                        // Scientific Context
                        const context = document.getElementById('context').textContent.trim();
                        addLabeledText('Scientific Context', context);
                        
                        // Real-World Significance
                        const significance = document.getElementById('significance').textContent.trim();
                        addLabeledText('Real-World Significance', significance);
                        
                        yPosition += 5; // Add extra space between sections
                        
                        // Main Discussion Points
                        ensureSpace(15);
                        addSectionHeading('Main Discussion Points');
                        
                        const keyPoints = document.getElementById('keyPoints');
                        
                        // Process each key point
                        const keyPointElements = keyPoints.querySelectorAll('.key-point');
                        keyPointElements.forEach((keyPoint, index) => {
                            ensureSpace(15);
                            
                            // Get the point heading
                            const heading = keyPoint.querySelector('.point-header h5').textContent.trim();
                            pdf.setFont('helvetica', 'bold');
                            pdf.setFontSize(12);
                            pdf.text(`${index + 1}. ${heading}`, margin, yPosition);
                            yPosition += 8;
                            
                            // Get the point content
                            const pointContent = keyPoint.querySelectorAll('.point-content ul li');
                            pdf.setFont('helvetica', 'normal');
                            pointContent.forEach(point => {
                                addBulletedItem(point.textContent.trim());
                            });
                            
                            // Add space between key points
                            yPosition += itemSpacing;
                        });
                        
                        // Practical Applications section
                        const applications = document.getElementById('applications');
                        if (applications.children.length > 0) {
                            ensureSpace(15);
                            addSectionHeading('Practical Applications & Real-World Examples');
                            
                            // Process each application
                            const applicationCards = applications.querySelectorAll('.application-card');
                            applicationCards.forEach((card, index) => {
                                ensureSpace(15);
                                
                                // Get the application scenario
                                const scenario = card.querySelector('.application-header h5').textContent.trim();
                                pdf.setFont('helvetica', 'bold');
                                pdf.setFontSize(12);
                                pdf.text(`${index + 1}. ${scenario}`, margin, yPosition);
                                yPosition += 8;
                                
                                // Get the explanation
                                const explanation = card.querySelector('p').textContent.trim();
                                
                                ensureSpace(Math.max((explanation.length / 40) * lineHeight + 5, 10));
                                pdf.setFont('helvetica', 'normal');
                                const explanationLines = pdf.splitTextToSize(explanation, pdfWidth - margin - 15);
                                pdf.text(explanationLines, margin + 10, yPosition);
                                yPosition += (explanationLines.length * lineHeight) + itemSpacing;
                            });
                            
                            yPosition += 5;
                        }
                    }
                    
                    // Save the PDF
                    pdf.save(`${filename}-${formatDate(new Date())}.pdf`);

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    // Always remove loading indicator
                    document.body.removeChild(loadingIndicator);
                }
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const quickJump = document.querySelector('.quick-jump');
            const menu = document.querySelector('.quick-jump-menu');
            if (!quickJump.contains(event.target) && menu.classList.contains('show')) {
                menu.classList.remove('show');
            }
        });
    </script>
</body>
</html> 